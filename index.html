<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Venn Explorer: Matrix, Sort & Zip</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        :root {
            /* Initial Fallback Colors */
            --c0: #e6194b; --bg0: rgba(230, 25, 75, 0.15);
            --c1: #4363d8; --bg1: rgba(67, 99, 216, 0.15);
            --c2: #f58231; --bg2: rgba(245, 130, 49, 0.15);
            --c3: #3cb44b; --bg3: rgba(60, 180, 75, 0.15);
            --tab-active: #2c3e50;
            --tab-inactive: #ecf0f1;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; color: #333; }

        /* SIDEBAR STYLES */
        #sidebar {
            width: 380px; background: #f9f9f9; border-right: 1px solid #ccc;
            display: flex; flex-direction: column; padding: 20px; box-sizing: border-box;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05); z-index: 10; flex-shrink: 0;
        }

        h2 { margin-top: 0; font-size: 1.4rem; color: #2c3e50; margin-bottom: 5px; }
        .subtitle { font-size: 0.85rem; color: #7f8c8d; margin-bottom: 15px; }

        .upload-section {
            background: #e3f2fd; border: 1px dashed #2196f3; padding: 10px;
            border-radius: 8px; margin-bottom: 15px; text-align: center;
        }
        .btn {
            border: 1px solid #2196f3; color: #2196f3; background-color: white;
            padding: 6px 12px; border-radius: 4px; font-weight: bold; cursor: pointer;
            transition: all 0.2s; font-size: 13px;
        }
        .btn:hover { background-color: #e3f2fd; }
        .upload-btn-wrapper { position: relative; display: inline-block; overflow: hidden; }
        .upload-btn-wrapper input[type=file] {
            font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer;
        }
        #file-status { font-size: 11px; margin-top: 5px; color: #666; font-style: italic; white-space: pre-wrap; }

        .search-section { margin-bottom: 15px; }
        .search-input {
            width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;
            font-size: 13px; box-sizing: border-box; transition: border-color 0.2s;
        }
        .search-input:focus { border-color: #4363d8; outline: none; }

        .controls-container {
            background: #fff; border: 1px solid #ddd; border-radius: 8px; 
            margin-bottom: 15px; overflow: hidden; flex-shrink: 0;
        }
        #control-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        #control-table th { background: #f1f3f5; padding: 8px; text-align: left; font-weight: 600; border-bottom: 1px solid #ddd; }
        #control-table td { padding: 8px; border-bottom: 1px solid #eee; vertical-align: middle; }
        
        .color-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; vertical-align: middle; margin-right: 8px; }
        input[type="checkbox"] { cursor: pointer; accent-color: #333; transform: scale(1.1); }

        #info-panel {
            display:none;
            background: #fff; border: 1px solid #ddd; border-left: 5px solid #333;
            padding: 10px; margin-bottom: 15px; border-radius: 4px; min-height: 40px; flex-shrink: 0;
        }
        #info-title { font-weight: 800; font-size: 1em; margin-bottom: 3px; display: block; }
        #info-desc { font-size: 0.85em; color: #666; line-height: 1.3; }

        /* SIDEBAR DATA TABLE */
        #table-wrapper { flex: 1; overflow-y: auto; border: 1px solid #eee; background: #fff; border-radius: 4px; }
        #data-table { width: 100%; border-collapse: collapse; font-size: 12px; table-layout: fixed; }
        #data-table th { 
            position: sticky; top: 0; background: #f1f3f5; text-align: left; 
            padding: 8px; border-bottom: 2px solid #ddd; font-weight: 600; z-index: 5;
            cursor: pointer; user-select: none;
        }
        #data-table th:hover { background: #e9ecef; }
        #data-table td { padding: 6px 8px; border-bottom: 1px solid #f0f0f0; word-wrap: break-word; }
        #data-table tr:nth-child(even) { background-color: #fcfcfc; }
        .sort-icon { display: inline-block; font-size: 10px; margin-left: 5px; width: 10px;}

        /* MAIN AREA & TABS */
        #main-container { flex: 1; display: flex; flex-direction: column; background: #fff; position: relative; }
        
        #tab-bar {
            display: flex; background: #f1f3f5; border-bottom: 1px solid #ddd; padding: 0 20px;
        }
        .tab-btn {
            padding: 12px 20px; cursor: pointer; font-weight: 600; font-size: 14px;
            color: #666; border-bottom: 3px solid transparent; transition: all 0.2s;
        }
        .tab-btn:hover { color: #333; background: rgba(0,0,0,0.02); }
        .tab-btn.active { color: #2c3e50; border-bottom-color: #2c3e50; background: #fff; }

        .view-panel { flex: 1; position: relative; display: none; overflow: hidden; }
        .view-panel.active { display: flex; justify-content: center; align-items: center; }

        /* VENN SVG */
        svg { width: 95%; height: 95%; max-width: 900px; max-height: 900px; }
        .venn-shape { fill: transparent; stroke-width: 3; mix-blend-mode: multiply; transition: fill 0.2s, stroke 0.2s; }
        .shape-0 { stroke: var(--c0); fill: var(--bg0); }
        .shape-1 { stroke: var(--c1); fill: var(--bg1); }
        .shape-2 { stroke: var(--c2); fill: var(--bg2); }
        .shape-3 { stroke: var(--c3); fill: var(--bg3); }
        .set-label-main { font-weight: 900; font-size: 22px; text-anchor: middle; text-transform: uppercase; user-select: none; text-shadow: 2px 2px 4px rgba(255,255,255,0.8); }
        .label-group { cursor: pointer; user-select: none; }
        .hit-area { fill: transparent; r: 24; pointer-events: all; transition: all 0.2s; }
        .count-text { font-size: 14px; font-weight: bold; fill: #222; text-anchor: middle; dominant-baseline: central; pointer-events: none; text-shadow: 0 0 3px #fff; }
        .label-group:hover .hit-area { fill: rgba(0,0,0,0.05); }
        .selected-region .hit-area { fill: #ffeb3b; stroke: #333; stroke-width: 2px; fill-opacity: 0.9; r: 14; }
        .selected-region .count-text { fill: #000; font-size: 16px; }

        /* MATRIX VIEW */
        #matrix-wrapper { 
            width: 100%; height: 100%; overflow: auto; padding: 20px; box-sizing: border-box; 
            align-items: flex-start; justify-content: flex-start;
        }
        #matrix-table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 600px; }
        #matrix-table th { 
            position: sticky; top: 0; background: #2c3e50; color: #fff; 
            padding: 10px; text-align: left; z-index: 5; 
        }
        #matrix-table td { padding: 8px 10px; border-bottom: 1px solid #eee; }
        #matrix-table tr:hover { background-color: #f1f8ff; }
        .matrix-tick { font-weight: bold; text-align: center; font-size: 16px; }

        /* TOOLTIP */
        #custom-tooltip {
            position: fixed; display: none; background: rgba(255, 255, 255, 0.98);
            border: 1px solid #ccc; padding: 12px; border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); pointer-events: none;
            z-index: 1000; font-size: 12px; line-height: 1.5; min-width: 150px;
        }
        .tooltip-row { display: flex; align-items: center; gap: 8px; margin-bottom: 2px; }
        .tooltip-tick { font-weight: bold; width: 15px; text-align: center; font-size: 14px; }
        .tooltip-count { margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee; font-weight: 700; color: #333; text-align: center; font-size: 13px; }
    </style>
</head>
<body>

<div id="custom-tooltip"></div>

<div id="sidebar">
    <h2 id="app-title">Venn Explorer</h2>
    <div class="subtitle" id="app-subtitle">Upload Config + Data (JSONs or ZIP)</div>
    
    <div class="upload-section">
        <div class="upload-btn-wrapper">
            <button class="btn">Select Files / Zip</button>
            <input type="file" id="file-upload" accept=".json, .zip" multiple />
        </div>
        <div id="file-status">Waiting for files...</div>
    </div>

    <div class="search-section">
        <input type="text" id="search-input" class="search-input" placeholder="Filter by Name or ID..." disabled />
    </div>

    <div class="controls-container">
        <table id="control-table">
            <thead>
                <tr>
                    <th style="width: 50%;">Dataset</th>
                    <th style="width: 25%; text-align: center;">Show</th>
                    <th style="width: 25%; text-align: center;">Select</th>
                </tr>
            </thead>
            <tbody id="control-tbody">
            </tbody>
        </table>
    </div>

    <div id="info-panel">
        <span id="info-title">Status</span>
        <span id="info-desc">No data loaded.</span>
    </div>

    <div id="table-wrapper">
        <table id="data-table">
            <thead>
                <tr>
                    <th onclick="handleTableSort('title')">Item Name <span id="sort-title" class="sort-icon"></span></th>
                    <th onclick="handleTableSort('id')">ID <span id="sort-id" class="sort-icon"></span></th>
                </tr>
            </thead>
            <tbody id="table-body"><tr><td colspan='2'>No data loaded</td></tr></tbody>
        </table>
    </div>
</div>

<div id="main-container">
    <div id="tab-bar">
        <div class="tab-btn active" onclick="switchView('chart')">Venn Chart</div>
        <div class="tab-btn" onclick="switchView('matrix')">Data Matrix</div>
    </div>

    <div id="view-chart" class="view-panel active">
        <div id="svg-container" style="width:100%; height:100%; display:flex; justify-content:center;"></div>
    </div>
    
    <div id="view-matrix" class="view-panel">
        <div id="matrix-wrapper">
            <table id="matrix-table">
                <thead id="matrix-head"></thead>
                <tbody id="matrix-body"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // --- 1. THEMES & GLOBALS ---
    
    const THEMES = {
        classic: ["#e6194b", "#4363d8", "#f58231", "#3cb44b"], 
        pastel:  ["#FF9AA2", "#C7CEEA", "#FFDAC1", "#B5EAD7"], 
        vibrant: ["#FF00FF", "#00FFFF", "#FFFF00", "#00FF00"], 
        dark:    ["#2C3E50", "#E74C3C", "#3498DB", "#F1C40F"]  
    };

    let ACTIVE_COLORS = [...THEMES.classic]; 
    let LOADED_CONFIG = []; 
    let DATA_CONFIG = []; 
    let currentData = [];
    let currentCounts = {};
    let activeSets = []; 
    let updateTimer = null;
    let searchTerm = "";
    let selectedRegionKey = null;
    let currentView = 'chart'; 
    let tableSort = { col: 'title', asc: true }; 

    // --- 2. HELPERS ---
    function hexToRgba(hex, alpha) {
        let c;
        if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)){
            c= hex.substring(1).split('');
            if(c.length== 3) c= [c[0], c[0], c[1], c[1], c[2], c[2]];
            c= '0x'+c.join('');
            return 'rgba('+[(c>>16)&255, (c>>8)&255, c&255].join(',')+','+alpha+')';
        }
        return `rgba(100,100,100,${alpha})`; 
    }

    function applyTheme(themeName) {
        const root = document.documentElement;
        let palette = THEMES.classic;
        if (THEMES[themeName]) palette = THEMES[themeName];
        else if (Array.isArray(themeName) && themeName.length === 4) palette = themeName;

        ACTIVE_COLORS = palette;
        palette.forEach((hex, i) => {
            if (i > 3) return;
            root.style.setProperty(`--c${i}`, hex);
            root.style.setProperty(`--bg${i}`, hexToRgba(hex, 0.15));
        });
    }

    // --- 3. UI SWITCHING & SORTING ---

    function switchView(view) {
        currentView = view;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        const activeBtn = Array.from(document.querySelectorAll('.tab-btn')).find(b => b.innerText.toLowerCase().includes(view === 'chart' ? 'venn' : 'matrix'));
        if(activeBtn) activeBtn.classList.add('active');
        document.querySelectorAll('.view-panel').forEach(p => p.classList.remove('active'));
        document.getElementById(`view-${view}`).classList.add('active');
        updateState();
    }

    function handleTableSort(col) {
        if (tableSort.col === col) tableSort.asc = !tableSort.asc;
        else { tableSort.col = col; tableSort.asc = true; }
        updateSortIcons();
        if(selectedRegionKey) showItems(selectedRegionKey);
    }

    function updateSortIcons() {
        document.querySelectorAll('.sort-icon').forEach(el => el.textContent = '');
        const arrow = tableSort.asc ? '▲' : '▼';
        document.getElementById(`sort-${tableSort.col}`).textContent = arrow;
    }

    // --- 4. FILE LOADING (UPDATED FOR ZIP) ---
    document.getElementById('file-upload').addEventListener('change', handleFiles);
    
    document.getElementById('search-input').addEventListener('input', (e) => {
        searchTerm = e.target.value.toLowerCase().trim();
        debounceUpdate();
    });

    async function handleFiles(event) {
        const rawFiles = Array.from(event.target.files);
        if (rawFiles.length === 0) return;

        const statusEl = document.getElementById('file-status');
        statusEl.textContent = "Processing files...";

        // A. Check for ZIP
        let processableFiles = [];
        const zipFile = rawFiles.find(f => f.name.toLowerCase().endsWith('.zip'));

        if (zipFile) {
            statusEl.textContent = "Unzipping...";
            try {
                const zip = new JSZip();
                const contents = await zip.loadAsync(zipFile);
                
                // Convert ZipObjects to simple file-like objects with a text() method
                for (const filename of Object.keys(contents.files)) {
                    if (!contents.files[filename].dir && filename.toLowerCase().endsWith('.json')) {
                        const content = await contents.files[filename].async("string");
                        processableFiles.push({
                            name: filename, // JSZip gives full path 'folder/file.json'
                            text: () => Promise.resolve(content)
                        });
                    }
                }
            } catch (err) {
                statusEl.textContent = "Error unzipping file.";
                console.error(err);
                return;
            }
        } else {
            // Use raw files (standard multiple upload)
            processableFiles = rawFiles;
        }

        if (processableFiles.length === 0) {
            statusEl.textContent = "No JSON files found.";
            return;
        }

        // B. Find Config (Robust check for inside folders)
        const configFile = processableFiles.find(f => 
            f.name.toLowerCase() === 'config.json' || f.name.toLowerCase().endsWith('/config.json')
        );
        
        if (!configFile) {
            statusEl.textContent = "Error: Missing 'config.json'.";
            statusEl.style.color = "red";
            return;
        }

        statusEl.textContent = "Reading configuration...";

        // C. Parse Config
        try {
            const configText = await configFile.text();
            const configJson = JSON.parse(configText);
            
            if(!configJson.datasets || !Array.isArray(configJson.datasets)) throw new Error("Invalid config format");

            if (configJson.title) {
                document.getElementById('app-title').textContent = configJson.title;
                document.title = configJson.title;
            }

            if (configJson.theme) applyTheme(configJson.theme);
            else applyTheme('classic');

            LOADED_CONFIG = configJson.datasets.map((ds, index) => ({
                key: ds.fileKeyword.toLowerCase(),
                label: ds.label,
                idField: ds.idField,
                nameField: ds.nameField,
                cssVarIndex: index % 4,
                order: index
            }));

        } catch (e) {
            statusEl.textContent = "Error parsing config.json";
            statusEl.style.color = "red";
            console.error(e);
            return;
        }

        // D. Process Data Files
        DATA_CONFIG = [];
        selectedRegionKey = null;
        let masterNameMap = new Map();
        
        // Sort files to ensure consistent loading order if important
        const sortedFiles = sortFilesByConfig(processableFiles);

        for (const file of sortedFiles) {
            // Skip config file
            if(file.name.toLowerCase().endsWith('config.json')) continue;

            const match = LOADED_CONFIG.find(cfg => file.name.toLowerCase().includes(cfg.key));
            if (match) {
                statusEl.textContent = `Reading ${file.name}...`;
                await processDataFile(file, match, masterNameMap);
            }
        }

        masterNameMap.clear(); 
        
        if (DATA_CONFIG.length === 0) {
            statusEl.textContent = "No data files matched the config keywords.";
            statusEl.style.color = "red";
            return;
        }

        statusEl.textContent = `Loaded ${DATA_CONFIG.length} datasets.`;
        statusEl.style.color = "green";
        document.getElementById('app-subtitle').textContent = "Data Loaded Successfully";
        document.getElementById('info-title').innerText = "Ready";
        document.getElementById('info-desc').innerText = "Use the table to filter datasets.";
        document.getElementById('search-input').disabled = false;
        
        initControls();
    }

    function sortFilesByConfig(files) {
        return files.sort((a, b) => {
            const cfgA = LOADED_CONFIG.find(c => a.name.toLowerCase().includes(c.key));
            const cfgB = LOADED_CONFIG.find(c => b.name.toLowerCase().includes(c.key));
            const orderA = cfgA ? cfgA.order : 99;
            const orderB = cfgB ? cfgB.order : 99;
            return orderA - orderB;
        });
    }

    function processDataFile(file, configEntry, nameMap) {
        return new Promise(resolve => {
            // Small delay to allow UI to update text
            setTimeout(() => {
                file.text().then(text => {
                    try {
                        const json = JSON.parse(text);
                        if (Array.isArray(json)) {
                            const cleanData = [];
                            const seenIds = new Set();
                            const limit = 20000; 
                            let count = 0;

                            for (const row of json) {
                                if (count > limit) break;
                                const id = cleanId(row[configEntry.idField]);
                                if (!id || id === 'x' || id.length < 1 || seenIds.has(id)) continue;
                                seenIds.add(id);

                                let name = nameMap.get(id) || row[configEntry.nameField] || `ID: ${id}`;
                                if (!nameMap.has(id) && row[configEntry.nameField]) {
                                    nameMap.set(id, row[configEntry.nameField]);
                                }

                                cleanData.push({ id: id, title: name });
                                count++;
                            }

                            DATA_CONFIG.push({
                                name: configEntry.label,
                                data: cleanData,
                                cssVarIndex: configEntry.cssVarIndex,
                                default: true
                            });
                        }
                    } catch (err) { console.error("Error reading file", file.name, err); }
                    resolve();
                }).catch(() => resolve());
            }, 10);
        });
    }

    function cleanId(rawId) {
        if (rawId == null) return null;
        return String(rawId).trim();
    }

    // --- 5. DATA LOGIC & UPDATES ---
    function initControls() {
        const tbody = document.getElementById('control-tbody');
        tbody.innerHTML = "";
        
        DATA_CONFIG.forEach((cfg, index) => {
            const tr = document.createElement('tr');
            
            const tdName = document.createElement('td');
            const dot = document.createElement('span');
            dot.className = 'color-dot';
            dot.style.backgroundColor = ACTIVE_COLORS[cfg.cssVarIndex]; 
            tdName.appendChild(dot);
            tdName.appendChild(document.createTextNode(cfg.name));
            
            const tdActive = document.createElement('td');
            tdActive.style.textAlign = 'center';
            const cbActive = document.createElement('input');
            cbActive.type = 'checkbox';
            cbActive.checked = cfg.default;
            cbActive.dataset.index = index;
            cbActive.dataset.type = 'active'; 
            cbActive.onchange = handleControlChange;
            tdActive.appendChild(cbActive);

            const tdSelect = document.createElement('td');
            tdSelect.style.textAlign = 'center';
            const cbSelect = document.createElement('input');
            cbSelect.type = 'checkbox';
            cbSelect.checked = false;
            cbSelect.dataset.index = index; 
            cbSelect.dataset.type = 'select'; 
            cbSelect.onchange = handleSelectionCheck; 
            tdSelect.appendChild(cbSelect);

            tr.appendChild(tdName);
            tr.appendChild(tdActive);
            tr.appendChild(tdSelect);
            tbody.appendChild(tr);
        });
        
        updateState();
    }

    function handleControlChange() { debounceUpdate(); }

    function handleSelectionCheck() {
        const activeCheckboxes = Array.from(document.querySelectorAll('input[data-type="active"]:checked'));
        let key = "";
        activeCheckboxes.forEach(activeCb => {
            const index = activeCb.dataset.index;
            const selCb = document.querySelector(`input[data-type="select"][data-index="${index}"]`);
            key += selCb.checked ? "1" : "0";
        });
        showItems(key);
    }

    function debounceUpdate() {
        if (updateTimer) clearTimeout(updateTimer);
        updateTimer = setTimeout(updateState, 50);
    }

    function updateState() {
        const activeCheckboxes = document.querySelectorAll('input[data-type="active"]');
        const selectedIndices = Array.from(activeCheckboxes).filter(cb => cb.checked).map(cb => parseInt(cb.dataset.index));
        
        activeSets = selectedIndices.map(i => DATA_CONFIG[i]);
        
        document.querySelectorAll('input[data-type="select"]').forEach(cb => {
            const idx = parseInt(cb.dataset.index);
            const isActive = selectedIndices.includes(idx);
            cb.disabled = !isActive;
            if(!isActive) cb.checked = false;
        });

        const numSets = activeSets.length;
        currentData = generateData(activeSets); // Generate union of data

        if (currentView === 'chart') {
            const container = document.getElementById('svg-container');
            if (numSets < 2 || numSets > 4) {
                container.innerHTML = `<div style="padding:20px;text-align:center;color:#999">Select 2, 3 or 4 sets.</div>`;
                document.getElementById('table-body').innerHTML = "";
                return;
            }
            currentCounts = calcCounts(currentData);
            drawSVG(numSets);
            if (selectedRegionKey && selectedRegionKey.length === numSets) {
                showItems(selectedRegionKey);
            } else {
                highlightSVG(null);
            }
        } else {
            // Matrix View
            renderMatrix(activeSets, currentData);
        }
    }

    function generateData(sets) {
        const map = new Map();
        sets.forEach((set, idx) => {
            set.data.forEach(item => {
                if (!map.has(item.id)) {
                    map.set(item.id, { id: item.id, title: item.title, sets: new Array(sets.length).fill(false) });
                }
                map.get(item.id).sets[idx] = true;
            });
        });

        let results = Array.from(map.values());
        if (searchTerm) {
            results = results.filter(item => 
                String(item.id).toLowerCase().includes(searchTerm) || 
                String(item.title).toLowerCase().includes(searchTerm)
            );
        }
        return results;
    }

    function calcCounts(data) {
        const counts = {};
        data.forEach(item => {
            const k = item.sets.map(b => b?'1':'0').join('');
            counts[k] = (counts[k] || 0) + 1;
        });
        return counts;
    }

    // --- 6. CHART DRAWING ---
    const LAYOUTS = {
        2: { shapes: [{cx:220,cy:300,r:160}, {cx:380,cy:300,r:160}], setLabels: [{x:140,y:120}, {x:460,y:120}], labels: {'10':{x:140,y:300},'01':{x:460,y:300},'11':{x:300,y:300}} },
        3: { shapes: [{cx:300,cy:220,r:160}, {cx:200,cy:380,r:160}, {cx:400,cy:380,r:160}], setLabels: [{x:300,y:40}, {x:50,y:550}, {x:550,y:550}], labels: {'100':{x:300,y:130},'010':{x:130,y:400},'001':{x:470,y:400},'110':{x:190,y:260},'101':{x:410,y:260},'011':{x:300,y:450},'111':{x:300,y:330}} },
        4: {
            isEllipse: true, globalTranslate: "translate(65, 105)", 
            shapes: [
                { rx:187.33, ry:115.33, transform:"rotate(40 -90.97 401.04)" },    
                { rx:187.33, ry:115.33, transform:"rotate(-40 325.97 -244.618)" },        
                { rx:187.33, ry:115.33, transform:"rotate(40 -245.112 345.13)" }, 
                { rx:187.33, ry:115.33, transform:"rotate(-40 480.112 -300.527)" }  
            ],
            setLabels: [{x:100,y:100}, {x:500,y:100}, {x:100,y:500}, {x:500,y:500}],
            labels: {
                '1000': {x:180, y: 160}, '0100': {x: 415, y: 160}, '0001': {x: 450, y: 411}, '0010': {x: 150, y: 413},
                '1100': {x: 300, y: 190}, '0101': {x: 442, y: 211}, '0011': {x: 300, y: 440}, '1010': {x: 160, y: 211},
                '1001': {x: 415, y: 350}, '0110': {x:180, y: 350}, '1101': {x: 387, y: 260}, '0111': {x: 250, y: 390},
                '1011': {x: 360, y: 380}, '1110': {x: 220, y: 260}, '1111': {x: 300, y: 300}
            }
        }
    };

    function drawSVG(num) {
        const container = document.getElementById('svg-container');
        const config = LAYOUTS[num];
        const ns = "http://www.w3.org/2000/svg";
        const svg = document.createElementNS(ns, "svg");
        svg.setAttribute("viewBox", "0 0 600 600");

        const group = document.createElementNS(ns, "g");
        if (config.globalTranslate) group.setAttribute("transform", config.globalTranslate);

        config.shapes.forEach((s, i) => {
            const el = document.createElementNS(ns, config.isEllipse ? "ellipse" : "circle");
            if (s.cx) { el.setAttribute("cx", s.cx); el.setAttribute("cy", s.cy); }
            if (config.isEllipse) { el.setAttribute("rx", s.rx); el.setAttribute("ry", s.ry); } else { el.setAttribute("r", s.r); }
            if (s.transform) el.setAttribute("transform", s.transform);
            el.setAttribute("class", `venn-shape shape-${activeSets[i].cssVarIndex}`);
            group.appendChild(el);
        });
        svg.appendChild(group);

        if(config.setLabels) {
            config.setLabels.forEach((pos, i) => {
                const txt = document.createElementNS(ns, "text");
                txt.setAttribute("x", pos.x); txt.setAttribute("y", pos.y);
                txt.setAttribute("class", "set-label-main");
                const colorVar = getComputedStyle(document.documentElement).getPropertyValue(`--c${activeSets[i].cssVarIndex}`).trim();
                txt.setAttribute("fill", colorVar);
                txt.textContent = activeSets[i].name;
                svg.appendChild(txt);
            });
        }

        Object.keys(config.labels).forEach(key => {
            const pos = config.labels[key];
            const count = currentCounts[key] || 0;
            const g = document.createElementNS(ns, "g");
            g.setAttribute("class", "label-group");
            g.setAttribute("id", "region-" + key);
            g.setAttribute("transform", `translate(${pos.x}, ${pos.y})`);
            
            g.onmousemove = (e) => updateTooltip(e, key, count, num);
            g.onmouseleave = () => document.getElementById('custom-tooltip').style.display = 'none';
            g.onclick = () => showItems(key);

            const hit = document.createElementNS(ns, "circle");
            hit.setAttribute("class", "hit-area");
            g.appendChild(hit);
            const txt = document.createElementNS(ns, "text");
            txt.setAttribute("class", "count-text");
            txt.textContent = count;
            g.appendChild(txt);
            svg.appendChild(g);
        });

        container.innerHTML = "";
        container.appendChild(svg);
    }

    // --- 7. MATRIX VIEW ---
    function renderMatrix(sets, data) {
        const thead = document.getElementById('matrix-head');
        const tbody = document.getElementById('matrix-body');
        
        // Headers
        let headHtml = `<tr><th>Game ID</th><th>Name</th>`;
        sets.forEach(s => {
            headHtml += `<th style="text-align:center; color: ${ACTIVE_COLORS[s.cssVarIndex]}">${s.name}</th>`;
        });
        headHtml += `</tr>`;
        thead.innerHTML = headHtml;

        // Limit rendering for performance
        const limit = 2000;
        const subset = data.slice(0, limit);
        
        let bodyHtml = "";
        if (data.length === 0) {
            bodyHtml = `<tr><td colspan="${2 + sets.length}">No data found.</td></tr>`;
        } else {
            subset.forEach(item => {
                bodyHtml += `<tr>
                    <td>${item.id}</td>
                    <td>${escapeHtml(item.title)}</td>`;
                item.sets.forEach((present, idx) => {
                    const col = ACTIVE_COLORS[sets[idx].cssVarIndex];
                    bodyHtml += `<td class="matrix-tick" style="color:${present ? col : '#eee'}">${present ? '✓' : '·'}</td>`;
                });
                bodyHtml += `</tr>`;
            });
            if (data.length > limit) {
                bodyHtml += `<tr><td colspan="${2 + sets.length}" style="text-align:center; color:#999">... Showing top ${limit} of ${data.length} items ...</td></tr>`;
            }
        }
        tbody.innerHTML = bodyHtml;
    }

    // --- 8. SIDEBAR TABLE LOGIC ---
    function showItems(key) {
        selectedRegionKey = key;
        highlightSVG(key);
        syncCheckboxes(key);

        let matches = currentData.filter(d => d.sets.map(b=>b?'1':'0').join('') === key);
        
        // Apply Sort
        matches.sort((a, b) => {
            let valA = a[tableSort.col] ? String(a[tableSort.col]).toLowerCase() : "";
            let valB = b[tableSort.col] ? String(b[tableSort.col]).toLowerCase() : "";
            if (valA < valB) return tableSort.asc ? -1 : 1;
            if (valA > valB) return tableSort.asc ? 1 : -1;
            return 0;
        });

        const tbody = document.getElementById('table-body');
        const limit = 200;
        const subset = matches.slice(0, limit);
        
        if (subset.length === 0) {
            tbody.innerHTML = "<tr><td colspan='2'>No matches</td></tr>";
        } else {
            let html = subset.map(m => `<tr><td>${escapeHtml(m.title)}</td><td>${m.id}</td></tr>`).join('');
            if (matches.length > limit) html += `<tr><td colspan='2' style="text-align:center; color:#999; font-style:italic">... Showing top ${limit} of ${matches.length} items ...</td></tr>`;
            tbody.innerHTML = html;
        }
        
        // Update Info Panel
        const inSets = [];
        key.split('').forEach((b, i) => { if(b==='1') inSets.push(activeSets[i].name); });
        let desc = `Included in: ${inSets.length ? inSets.join(" + ") : "None"} (${matches.length})`;
        if(searchTerm) desc += ` [Filtered]`;
        document.getElementById('info-title').innerText = "Selection";
        document.getElementById('info-desc').innerText = desc;
    }

    function highlightSVG(key) {
        document.querySelectorAll('.selected-region').forEach(el => el.classList.remove('selected-region'));
        if (!key) return;
        const el = document.getElementById('region-' + key);
        if (el) el.classList.add('selected-region');
    }

    function syncCheckboxes(key) {
        const bits = key.split('');
        document.querySelectorAll('input[data-type="select"]').forEach(cb => cb.checked = false);

        activeSets.forEach((set, idx) => {
            if (bits[idx] === '1') {
                const originalIndex = DATA_CONFIG.indexOf(set);
                const cb = document.querySelector(`input[data-type="select"][data-index="${originalIndex}"]`);
                if(cb) cb.checked = true;
            }
        });
    }

    function escapeHtml(text) {
        if (!text) return text;
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }
    
    const tooltip = document.getElementById('custom-tooltip');
    function updateTooltip(e, key, count, num) {
        let html = "";
        for(let i=0; i<num; i++) {
            const isInc = key[i] === '1';
            const colorVar = getComputedStyle(document.documentElement).getPropertyValue(`--c${activeSets[i].cssVarIndex}`).trim();
            const col = isInc ? colorVar : '#ccc';
            html += `<div class="tooltip-row"><span class="tooltip-tick" style="color:${col}">${isInc?'✓':'✗'}</span><span style="color:${col}">${activeSets[i].name}</span></div>`;
        }
        html += `<div class="tooltip-count">Count: ${count}</div>`;
        tooltip.innerHTML = html;
        tooltip.style.display = 'block';
        tooltip.style.left = (e.pageX + 15) + 'px';
        tooltip.style.top = (e.pageY + 15) + 'px';
    }
</script>
</body>
</html>
